<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard Document Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ls-min:140px; --ls-max:360px; --ls-w:220px;
      --us-min:160px; --us-max:420px; --us-w:260px;
      --bar-w:6px;
      --shadow: 0 1px 3px rgba(0,0,0,.08),0 6px 20px rgba(0,0,0,.06);
      --bg:#f8f9fa; --card:#fff; --text:#2c3e50; --muted:#7f8c8d; --brand:#2c5aa0;
      --accent:#1a5276; --light-bg:#e8f4f8; --border:#d6eaf8;
      --success:#28a745; --warning:#ffc107; --danger:#dc3545;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Segoe UI', system-ui, -apple-system, Roboto, Arial;color:var(--text);background:var(--bg);}
    .app{height:100vh;display:grid;
      grid-template-columns:var(--ls-w) var(--bar-w) var(--us-w) var(--bar-w) 1fr;
      transition:grid-template-columns .2s ease;}
    .collapse-ls{grid-template-columns:0 var(--bar-w) var(--us-w) var(--bar-w) 1fr;}
    .collapse-us{grid-template-columns:var(--ls-w) var(--bar-w) 0 var(--bar-w) 1fr;}
    .collapse-both{grid-template-columns:0 0 0 0 1fr;}
    .sidebar{background:var(--card);box-shadow:var(--shadow);display:flex;flex-direction:column;}
    .ls{padding:14px;position:relative;overflow-y:visible;background:var(--light-bg);}
    .us{padding:16px;position:relative;overflow:auto;background:var(--light-bg);}
    .main{background:transparent;padding:24px;overflow:auto;}
    .pane-title{font-size:14px;font-weight:600;color:var(--accent);margin:2px 0 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding-bottom:8px;}
    .btn{border:0;border-radius:8px;padding:10px 12px;font-weight:600;cursor:pointer;
         background:#e8f4f8;color:#2c5aa0;width:100%;text-align:left;margin-bottom:8px;transition:all 0.2s ease;}
    .btn:hover{background:#d6eaf8;transform:translateY(-1px);}
    .btn.brand{background:var(--brand);color:#fff;}
    .btn.inline{width:auto;margin:0 8px 0 0;padding:8px 10px;}
    .muted{color:var(--muted);}
    /* ÁßªÈô§ÂàÜÂâ≤Á∫øÁöÑÊãñÊãΩÊ†∑Âºè */
    .resizer{
      position:relative;
      background:transparent;
      width:var(--bar-w);
    }
    .resizer::after{
      content:"";
      position:absolute;
      top:0;
      bottom:0;
      left:calc(50% - 1px);
      width:2px;
      background:#d6eaf8;
    }
    .topbar{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;padding:10px;background:var(--card);border-bottom:1px solid #eee;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .upload-card{background:#f8fbff;border:1px dashed #b3d9ff;border-radius:12px;padding:14px;}
    input[type="file"]{width:100%;margin:10px 0;padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff;}
    .logout{display:block;margin-top:12px;color:var(--muted);text-decoration:none;font-weight:500;}
    .collapse-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      width: 18px;
      height: 24px;
      border: none;
      border-radius: 4px;
      background: #b3d9ff;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      color: var(--brand);
    }
    .collapse-btn:hover { background: #99ccff; }
    .document-item {
      position: relative;
      padding: 8px 24px 8px 8px;
      margin: 4px 0;
      background: #e8f4f8;
      border-radius: 6px;
      cursor: grab;
      border: 1px solid #b3d9ff;
      transition: all 0.2s ease;
    }
    .document-item:hover {
      background: #d6eaf8;
      transform: translateY(-1px);
    }
    .document-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    .document-delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 16px;
      height: 16px;
      border: none;
      background: #ffebee;
      border-radius: 50%;
      cursor: pointer;
      color: #c62828;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .document-delete-btn:hover {
      background: #ffcdd2;
    }
    .category {
      margin-bottom: 12px;
      position: relative;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px dashed transparent;
      background: #e8f4f8;
    }
    .category:hover {
      background: #d6eaf8;
    }
    .category.drag-over {
      border-color: var(--brand);
      background: #cfe2f3;
      transform: scale(1.02);
    }
    .category-title {
      font-weight: bold;
      margin-bottom: 6px;
      color: var(--accent);
    }
    .documents-list {
      min-height: 20px;
      padding: 4px;
      border-radius: 6px;
      background: #f8fbff;
    }
    .active-category {
      background: #d5e8d4 !important;
      border-left: 4px solid #4caf50;
    }
    .delete-category {
      position: absolute;
      top: 0;
      right: 0;
      width: 20px;
      height: 20px;
      border: none;
      background: #ffebee;
      border-radius: 4px;
      cursor: pointer;
      color: #c62828;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .category:hover .delete-category {
      opacity: 1;
    }
    .delete-category:hover {
      background: #ffcdd2;
    }
    .action-btn {
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 8px;
      transition: all 0.2s ease;
    }
    .action-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .action-btn.secondary {
      background: #4caf50;
    }
    .topbar-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }
    .add-category-icon {
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 4px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }
    .add-category-icon:hover {
      opacity: 0.9;
    }
    /* When a sidebar is collapsed, fully hide its visuals (no shadow, no padding, no overflow). */
    .app.collapse-ls #ls,
    .app.collapse-both #ls {
      box-shadow: none !important;
      padding: 0 !important;
      overflow: hidden !important;
      width: 0 !important;
      min-width: 0 !important;
    }
    /* Hide the left resizer's vertical line when LS is collapsed to avoid a pale seam */
    .app.collapse-ls #bar-ls::after,
    .app.collapse-both #bar-ls::after { opacity: 0; }
    .app.collapse-us #us,
    .app.collapse-both #us {
      box-shadow: none !important;
      padding: 0 !important;
      overflow: hidden !important;
      width: 0 !important;
      min-width: 0 !important;
    }
    /* Hide the right resizer's vertical line when US is collapsed */
    .app.collapse-us #bar-us::after,
    .app.collapse-both #bar-us::after { opacity: 0; }
    /* Prevent the collapsed pane from capturing clicks */
    .app.collapse-ls #ls,
    .app.collapse-us #us { pointer-events: none; }
    /* Keep the resizer buttons clickable */
    #bar-ls, #bar-us { position: relative; }
    #bar-ls .collapse-btn, #bar-us .collapse-btn { pointer-events: auto; }
    /* Stick account section to bottom of left sidebar */
    .ls {
      display: flex;
      flex-direction: column;
    }
    .account-section {
      margin-top: auto; /* push to bottom */
    }

    /* Template Selector Modal Styles */
    .template-selector-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1001;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .template-selector-container {
      width: 70%;
      height: 70%;
      max-width: 800px;
      max-height: 600px;
      background: white;
      border-radius: 8px;
      display: flex;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .template-selector-modal .sidebar {
      width: 200px;
      background-color: #f0f4f8;
      border-right: 1px solid #d6eaf8;
      padding: 15px;
      overflow-y: auto;
    }

    .template-selector-modal .sidebar-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .template-selector-modal .sidebar-section {
      margin-bottom: 20px;
    }

    .template-selector-modal .sidebar-section-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: bold;
    }

    .template-selector-modal .sidebar-item {
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .template-selector-modal .sidebar-item:hover {
      background-color: #e8f4f8;
    }

    .template-selector-modal .sidebar-item.active {
      background-color: #d6eaf8;
      font-weight: bold;
      color: var(--accent);
    }

    .template-selector-modal .arrow-icon {
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 4px solid var(--muted);
      margin-left: 8px;
    }

    .template-selector-modal .content-area {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      position: relative;
    }

    .template-selector-modal .content-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-content: flex-start;
    }

    .template-selector-modal .content-box {
      width: 240px;
      border: 1px solid #d6eaf8;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      background: #f8fbff;
      transition: all 0.2s ease;
    }

    .template-selector-modal .content-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .template-selector-modal .content-box-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--accent);
    }

    .template-selector-modal .content-box-description {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .template-selector-modal .content-box-footer {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #999;
    }

    .template-selector-modal .generate-button {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background-color: var(--brand);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .template-selector-modal .generate-button:hover {
      background-color: #1a4a7a;
    }

    .hidden {
      display: none;
    }

    /* Categories container for better organization */
    .categories-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    
    /* NEW STYLES - Enhanced UI to match the image */
    .main h1 {
      color: var(--accent);
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 24px;
    }
    
    .main-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    
    .document-preview {
      background: #f8fbff;
      border: 1px solid #d6eaf8;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .document-preview h2 {
      color: var(--accent);
      margin-top: 0;
      font-size: 20px;
      border-bottom: 1px solid #d6eaf8;
      padding-bottom: 8px;
    }
    
    .document-preview h3 {
      color: var(--brand);
      margin-top: 15px;
      font-size: 16px;
    }
    
    .document-preview ul {
      padding-left: 20px;
    }
    
    .document-preview li {
      margin-bottom: 5px;
    }
    
    .document-preview strong {
      color: var(--accent);
    }
    
    /* Enhanced sidebar styling */
    .ls .pane-title {
      font-size: 16px;
      color: var(--brand);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    .account-section .pane-title {
      font-size: 16px;
      color: var(--brand);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    /* Enhanced button styling */
    .btn {
      border-radius: 6px;
      padding: 10px 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }
    
    .btn:before {
      content: "‚Ä¢";
      margin-right: 8px;
      color: var(--brand);
    }
    
    .btn.brand:before {
      color: white;
    }
    
    /* Enhanced category styling */
    .category {
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #d6eaf8;
      background: #f8fbff;
    }
    
    .category-title {
      font-size: 14px;
      color: var(--accent);
    }
    
    .active-category {
      background: #e8f5e8 !important;
      border-left: 4px solid var(--success);
    }
    
    /* Enhanced topbar styling */
    .topbar {
      background: white;
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .topbar .muted {
      font-weight: 500;
    }
    
    /* Enhanced upload card */
    .upload-card {
      background: #f8fbff;
      border: 2px dashed #b3d9ff;
      border-radius: 8px;
      padding: 16px;
    }
    
    /* Document list styling */
    .documents-list {
      background: white;
      border-radius: 6px;
      padding: 8px;
      border: 1px solid #e8f4f8;
    }
    
    /* Document item styling */
    .document-item {
      background: white;
      border: 1px solid #e8f4f8;
      border-radius: 6px;
      padding: 10px 30px 10px 12px;
      margin: 6px 0;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .document-item:hover {
      background: #f0f8ff;
      border-color: #b3d9ff;
    }
    
    /* Welcome message styling */
    .welcome-message {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 5px;
    }
    
    .profession-badge {
      display: inline-block;
      background: var(--light-bg);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 10px;
    }
  </style>
</head>
<body>
<div id="app" class="app">
  
  <aside id="ls" class="sidebar ls">
    <div class="pane-title">
      ALL DOCUMENT
      <button id="addCategoryBtn" class="add-category-icon">+</button>
    </div>
    <div class="categories-container">
      <div class="category active-category" data-category="all">
        <div class="category-title">All Documents</div>
      </div>
     
    <div class="account-section">
      <div class="pane-title">Account</div>
      <button class="btn" onclick="window.location.href='/feedback'">User Feedback</button>
      <button class="btn">{{ latest_membership }}</button>
      <button class="btn" onclick="window.location.href='/membership'">Purchase Plan</button>
      <a class="logout" href="/logout">Log Out</a>
    </div>
  </aside>

  <div id="bar-ls" class="resizer">
    <button id="btnLS" class="collapse-btn">¬´</button>
  </div>
  <aside id="us" class="sidebar us">
    <div class="pane-title">Upload Document</div>
    <div class="upload-card">
      <form id="uploadForm" action="/upload-document" method="post" enctype="multipart/form-data">
        <input type="file" name="file" required multiple />
        <button type="submit" class="btn brand" style="width:100%">Upload</button>
      </form>
    </div>
    <div class="pane-title" style="margin-top:16px">Documents</div>
    <div id="current-category" class="muted" style="margin-bottom:6px">Showing: All Documents</div>
    <div id="documents-container" class="documents-list"></div>
  </aside>
  <div id="bar-us" class="resizer">
    <button id="btnUS" class="collapse-btn">¬´</button>
  </div>
  <main class="main">
    <div class="topbar">
      <div class="welcome-message">Welcome, {{ name }}</div>
      <div class="profession-badge">{{ profession }}</div>
      <div class="topbar-actions">
        <button id="downloadBtn" class="action-btn secondary">Download</button>
        {% if latest_membership != "Free" %}
          <button id="generateBtn" class="action-btn">Generate</button>
        {% else %}
          <button id="generateBtn" class="action-btn" disabled title="Upgrade to use Generate">Generate</button>
        {% endif %}
      </div>
    </div>
    
    <div class="main-content">
      <h1>PCP Project 1</h1>
      
      <div class="document-preview">
        <h2>Narrative Record of the PCP Project Briefing ‚Äì 7th July</h2>
        
        <p>The existing construction with the first four years has been a vision for our future acquisitions. Our mission is prosperous. With our key defects, an exciting experience at the university. Plans installed within our newly and formerly new business partners include "Skin Solutions" (sunshine), full-time company and special service delivery team during the year, including programs starting to "Bills up" into, but all along with "Mix now was underway" and eventually ending the acquisition in the transition metal portfolio market position on the Project Capitaine Project (FCP).</p>
        
        <h3>Setting the Stage: Purpose and Expectation</h3>
        
        <p>From critical to customer objectives, to gain its cleanest image for FCP projects, each stage continues to continue, and results consistent with the anticipated level of development, social growth project details, which we take into account, including successors in process management and process. We recognise that planned initiatives can be coming forward as part of the planning, "for future, challenging," and are able to provide further information.</p>
        
        <p>We plan a dedicated business for project and guide assignments, highlighting the transformation potential of the PCP. "This second of knowledge puts this goal from the project, to incorporate core solutions they've done in other branches, from the competition industry. So if you are confident that if you have the knowledge of the tool," the record was encouraging, and there might indicate that this project is a unique opportunity for growth and product learning.</p>
        
        <h3>Individual and Group Accountability</h3>
        
        <p>From additional third-years of prior work, continuously and opportunistically taking place together with client needs in Argentina & Honduras. The final position is written to highly, accorded to a written fit group, whether one or Gamma, or two or two groups included in the report, where the person is named "I am"; what is clear for the FCP, every group member must understand the entire product, and will then assigned suit, "When I am the customers", when you come for the number one, written text, from the title group, individual written text?</p>
        
        <p><strong>Evaluation:</strong> Each subject must be able to explain and identify the main product, and will then respond.</p>
        
        <p><strong>Admission:</strong></p>
        <ul>
          <li><strong>Key Data and Attendance</strong></li>
          <li>From Actualities to Auditors to the project</li>
          <li>The July Project funding facility</li>
          <li>Total Equipment: Special Stock Accounts</li>
          <li>Total Equipment: Board of Directors</li>
          <li>Job Retirement: First Assurance Fee</li>
          <li>Allocation: The Employee of Admissions "Assessment due on a re-association. So even though you want a suitable way to say you didn't have up for the assessment, you don't plan, likely use things on that."</li>
        </ul>
        
        <p><strong>Admission:</strong> All students must attend these dates and ensure their availability.</p>
        
        <h3>Originality and Process Over Product</h3>
        
        <p>There are not many advantages in determining how, why, who should be required to facilitate your resolution. This will undoubtedly contribute to all contributing time and timely. But for some tasks with signs, need to be prepared. This means that you go to the project. As the museum is provided, you just be prepared soon!" The focus here exists. The outstanding academic beauty that the world will achieve towards.</p>
        
        <h3>Group Formation and Real-World Dynamics</h3>
        
        <p>Including all the activities of great excellence. These aspects of our life currently have stopped expanding beyond the rolling spot schedule and exhibition conditions. To the end, each takes you give them plans that working with the people known by the team, giving them a true generation of time, also for those outstanding projects developed.</p>
        
        <p><strong>Assessment Criteria:</strong> Ability to reach a higher level of confidence and complete a successful approach for the period.</p>
        
        <h3>Supervisor's Role and Client Simulation</h3>
        
        <p>From consultants to supervisors with an employee to a client, providing resources to the facilities, "You Avancate and Be a client... It was my own seven local of requirements in a general guideline that from three years start free that have been proven to be important your product." This resulted in client relationships in relation to fellow communications and hospitality.</p>
        
        <h3>Technical Support and Self-Malance</h3>
        
        <p>Additional content would go here...</p>
      </div>
    </div>
  </main>
</div>

<!-- Template Selector Modal -->
<div id="templateSelectorModal" class="template-selector-modal hidden">
  <div class="template-selector-container">
    <div class="sidebar">
      <div class="sidebar-title">Select Summary Template</div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">Recently Used</div>
        <!-- Items would go here -->
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">General</div>
        <div class="sidebar-item" onclick="showTemplateContent('meeting')">
          Meeting
          <div class="arrow-icon"></div>
        </div>
        <div class="sidebar-item" onclick="showTemplateContent('speech')">
          Speech
          <div class="arrow-icon"></div>
        </div>
        <div class="sidebar-item" onclick="showTemplateContent('call')">
          Call
          <div class="arrow-icon"></div>
        </div>
        <div class="sidebar-item">
          Interview
          <div class="arrow-icon"></div>
        </div>
        <div class="sidebar-item">
          Medical
          <div class="arrow-icon"></div>
        </div>
        <div class="sidebar-item">
          Sales
          <div class="arrow-icon"></div>
        </div>
      </div>
    </div>
    
    <div class="content-area">
      <div id="meeting-content" class="hidden">
        <div class="content-container">
          <div class="content-box">
            <div class="content-box-title">Meeting Summary Template</div>
            <div class="content-box-description">Summarizes key points, decisions, and action items from meetings.</div>
            <div class="content-box-footer">
              <span>Last used: 2 days ago</span>
            </div>
          </div>
          <div class="content-box">
            <div class="content-box-title">Detailed Meeting Notes</div>
            <div class="content-box-description">Comprehensive template for capturing all meeting details.</div>
            <div class="content-box-footer">
              <span>Last used: 1 week ago</span>
            </div>
          </div>
        </div>
      </div>

      <div id="speech-content" class="hidden">
        <div class="content-container">
          <div class="content-box">
            <div class="content-box-title">Speech Summary</div>
            <div class="content-box-description">Captures main arguments and key quotes from speeches.</div>
            <div class="content-box-footer">
              <span>Last used: 3 days ago</span>
            </div>
          </div>
        </div>
      </div>
      <div id="call-content" class="hidden">
        <div class="content-container">
          <div class="content-box">
            <div class="content-box-title">Call Transcript Summary</div>
            <div class="content-box-description">Summarizes phone call transcripts with key points.</div>
            <div class="content-box-footer">
              <span>Last used: Yesterday</span>
            </div>
          </div>
          <div class="content-box">
            <div class="content-box-title">Customer Support Call</div>
            <div class="content-box-description">Specialized template for customer support calls.</div>
            <div class="content-box-footer">
              <span>Last used: 5 days ago</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <button class="generate-button">Generate now</button>
  </div>
</div>

<script>
    const $ = selector => document.querySelector(selector);
    const $$= selector => document.querySelectorAll(selector);
    const app = $('#app');
  
    function initResizeButtons() {
      $('#btnLS').textContent = '¬´';
      $('#btnUS').textContent = '¬´';
    }
  
    // Add these new functions for state management
    function state() {
      return {
        hasLS: !app.classList.contains('collapse-ls'),
        hasUS: !app.classList.contains('collapse-us')
      }
    }
  
    function applyCollapse(ls, us) {
      app.classList.toggle('collapse-ls', !ls);
      app.classList.toggle('collapse-us', !us);
      app.classList.toggle('collapse-both', !ls && !us);
      
      // Update button directions
      const btnLS = document.getElementById('btnLS');
      const btnUS = document.getElementById('btnUS');
      if (btnLS) { btnLS.textContent = ls ? '¬´' : '¬ª'; }
      if (btnUS) { btnUS.textContent = us ? '¬´' : '¬ª'; }
    }
  
    // Update the button click handlers
    $('#btnLS').onclick = () => {
      const s = state();
      applyCollapse(!s.hasLS, s.hasUS);
    };
  
    $('#btnUS').onclick = () => {
      const s = state();
      applyCollapse(s.hasLS, !s.hasUS);
    };
  
    function createDocumentItem(doc) {
      const div = document.createElement('div');
      div.className = 'document-item';
      div.textContent = doc.filename;
      div.dataset.docId = doc.id; // Store document ID
      div.dataset.fileName = doc.filename; // Store filename for drag operations
      div.draggable = true; // Enable dragging
      div.onclick = () => window.open(`/view-document/${doc.id}`, '_blank');
  
      const delBtn = document.createElement('button');
      delBtn.className = 'document-delete-btn';
      delBtn.textContent = 'üóë';
      delBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm(`Delete "${doc.filename}"?`)) {
          await fetch(`/delete-document/${doc.id}`, { method: 'GET' });
          loadDocuments();
        }
      };
      
      // Add drag event listeners
      div.addEventListener('dragstart', function(e) {
        this.classList.add('dragging');
        e.dataTransfer.setData('text/plain', JSON.stringify({
          docId: this.dataset.docId,
          fileName: this.dataset.fileName
        }));
        e.dataTransfer.effectAllowed = 'move';
      });
      
      div.addEventListener('dragend', function() {
        this.classList.remove('dragging');
      });
      
      div.appendChild(delBtn);
      return div;
    }
  
    async function loadDocuments() {
      const res = await fetch('/get-documents');
      const docs = await res.json();
  
      const container = $('#documents-container');
      container.innerHTML = '';
      docs.forEach(doc => container.appendChild(createDocumentItem(doc)));
    }
  
    // ENHANCED: Category management with drag & drop and persistence
    const userId = "{{ session.get('user_id', '') }}";
    let categories = [];
    let documentCategories = {};    // optional in-memory mapping (we rely on server)
    let currentCategory = 'all';

  
    // Save categories to localStorage
    function saveCategories() {
      localStorage.setItem('userCategories', JSON.stringify(categories));
      localStorage.setItem('documentCategories', JSON.stringify(documentCategories));
    }

    // Add new category
    async function addCategory(name) {
  if (!name || !name.trim()) {
    alert("Category name cannot be empty.");
    return;
  }
  try {
    const res = await fetch("/add_category", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: name.trim() })
    });
    const result = await res.json();
    if (result.success) {
      // append to client-side list and rerender
      categories.unshift({ id: result.id, name: result.name });
      renderCategories();
    } else {
      alert("Failed to add category: " + (result.error || "Unknown error"));
    }
  } catch (err) {
    console.error("Error adding category:", err);
    alert("Error adding category. See console.");
  }
}


    // Delete category
    async function deleteCategory(categoryId) {
  if (!confirm('Are you sure you want to delete this category? Documents will be moved back to All Documents.')) return;
  try {
    const res = await fetch(`/delete_category/${categoryId}`, { method: "DELETE" });
    const result = await res.json();
    if (result.success) {
      categories = categories.filter(cat => String(cat.id) !== String(categoryId));
      // If we were viewing that category, switch to 'all'
      if (currentCategory === String(categoryId)) setCurrentCategory('all');
      renderCategories();
      loadDocuments(); // refresh documents
    } else {
      alert("Failed to delete category: " + (result.error || "Unknown error"));
    }
  } catch (err) {
    console.error("Error deleting category:", err);
    alert("Error deleting category. See console.");
  }
}


    // Setup drop zone for category
    function setupDropZone(categoryElement) {
      categoryElement.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
      });
      
      categoryElement.addEventListener('dragleave', function(e) {
        if (!this.contains(e.relatedTarget)) {
          this.classList.remove('drag-over');
        }
      });
      
      categoryElement.addEventListener('drop', async function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        try {
          const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
          const targetCategory = this.dataset.category;
          
          // Update document category in database
          const response = await fetch('/update-document-category', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              documentId: dragData.docId,
              category: targetCategory === 'all' ? null : targetCategory
            })
          });
          
          if (response.ok) {
            // Update local storage
            if (targetCategory === 'all') {
              delete documentCategories[dragData.docId];
            } else {
              documentCategories[dragData.docId] = targetCategory;
            }
            saveCategories();
            
            // Refresh documents if needed
            loadDocuments();
            
            console.log(`Moved "${dragData.fileName}" to ${targetCategory === 'all' ? 'All Documents' : this.querySelector('.category-title').textContent}`);
          } else {
            alert('Failed to update document category');
          }
        } catch (error) {
          console.error('Error handling drop:', error);
        }
      });
    }

    // Render categories in sidebar
    function renderCategories() {
  const container = document.querySelector('.categories-container');

  // Keep "All Documents" category (already in DOM) ‚Äî remove any other custom categories first
  const allDocsCategory = container.querySelector('.category[data-category="all"]');

  const existingCategories = container.querySelectorAll('.category:not([data-category="all"])');
  existingCategories.forEach(el => el.remove());

  // Add categories from server
  categories.forEach(category => {
    const categoryEl = document.createElement('div');
    categoryEl.className = 'category';
    categoryEl.dataset.category = String(category.id);

    const titleEl = document.createElement('div');
    titleEl.className = 'category-title';
    titleEl.textContent = category.name;

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-category';
    deleteBtn.textContent = 'üóë';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      deleteCategory(category.id);
    };

    categoryEl.appendChild(titleEl);
    categoryEl.appendChild(deleteBtn);

    // click to switch
    categoryEl.onclick = () => setCurrentCategory(String(category.id));

    // make it a dropzone
    setupDropZone(categoryEl);

    container.appendChild(categoryEl);
  });

  // ensure the active category class exists
  const activeEl = container.querySelector(`.category[data-category="${currentCategory}"]`);
  if (activeEl) {
    container.querySelectorAll('.category').forEach(c => c.classList.remove('active-category'));
    activeEl.classList.add('active-category');
  }
}


    // Set current category and update display
    function setCurrentCategory(categoryId) {
      currentCategory = categoryId;
      
      // Update active state
      $$('.category').forEach(c => c.classList.remove('active-category'));
      $(`.category[data-category="${categoryId}"]`).classList.add('active-category');
      
      // Update current category display
      const categoryName = categoryId === 'all' ? 'All Documents' : 
        categories.find(cat => cat.id === categoryId)?.name || categoryId;
      $('#current-category').textContent = `Showing: ${categoryName}`;
      
      // Filter and display documents
      filterDocuments();
    }

    // Filter documents based on current category
    async function filterDocuments() {
  const res = await fetch('/get-documents');
  const docs = await res.json();

  let filteredDocs = docs;

  if (currentCategory !== 'all') {
    filteredDocs = docs.filter(doc => String(doc.category) === String(currentCategory));
  }

  const container = $('#documents-container');
  container.innerHTML = '';
  filteredDocs.forEach(doc => container.appendChild(createDocumentItem(doc)));
}


    document.addEventListener('DOMContentLoaded', () => {
      initResizeButtons();
      loadCategories();       // load categories from server
      loadDocuments();        // load documents (documents include category field)

      
      // Setup "All Documents" category
      const allDocsCategory = $('.category[data-category="all"]');
      if (allDocsCategory) {
        allDocsCategory.onclick = () => setCurrentCategory('all');
        setupDropZone(allDocsCategory);
      }
      
      // Initialize button arrow directions to match current state
      const s = state();
      const btnLS = document.getElementById('btnLS');
      const btnUS = document.getElementById('btnUS');
      if (btnLS) { btnLS.textContent = s.hasLS ? '¬´' : '¬ª'; }
      if (btnUS) { btnUS.textContent = s.hasUS ? '¬´' : '¬ª'; }
    });
  
    document.addEventListener("DOMContentLoaded", function () {
      const addCategoryBtn = document.getElementById("addCategoryBtn");
  
      addCategoryBtn.addEventListener("click", function () {
        const name = prompt("Enter new category name:");
        if (name) {
          addCategory(name);
        }
      });
    });
  
    // Load categories from server
    async function loadCategories() {
      try {
        const res = await fetch("/get_categories");
        const result = await res.json();
        if (result.success) {
          categories = result.categories;
          renderCategories();
        } else {
          console.error("Failed to load categories:", result.error);
        }
      } catch (err) {
        console.error("Error loading categories:", err);
      }
    }
  
    // Initialize categories on page load
    document.addEventListener('DOMContentLoaded', loadCategories);

    // Template selector modal functionality
    const generateBtn = document.getElementById('generateBtn');
    const templateSelectorModal = document.getElementById('templateSelectorModal');
    const generateNowBtn = templateSelectorModal.querySelector('.generate-button');
    
    if (generateBtn && !generateBtn.disabled) {
      generateBtn.addEventListener('click', function() {
        templateSelectorModal.classList.remove('hidden');
        showTemplateContent('meeting'); // Show default content
      });
    }
    
    // Close modal when clicking outside
    templateSelectorModal.addEventListener('click', function(e) {
      if (e.target === templateSelectorModal) {
        templateSelectorModal.classList.add('hidden');
      }
    });
    
    generateNowBtn.addEventListener('click', function() {
      alert('Generating document...');
      templateSelectorModal.classList.add('hidden');
    });
    
    function showTemplateContent(templateType) {
      // Hide all content areas
      const contentAreas = document.querySelectorAll('.content-area > div');
      contentAreas.forEach(area => area.classList.add('hidden'));
      
      // Show selected content
      const selectedContent = document.getElementById(`${templateType}-content`);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }
      
      // Update active state in sidebar
      const sidebarItems = document.querySelectorAll('.sidebar-item');
      sidebarItems.forEach(item => item.classList.remove('active'));
      
      const activeItem = Array.from(sidebarItems).find(item => 
        item.textContent.trim().toLowerCase().includes(templateType.toLowerCase())
      );
      if (activeItem) {
        activeItem.classList.add('active');
      }
    }
</script>
</body>
</html>

