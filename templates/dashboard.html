
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard Document Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    :root{
      --ls-min:140px; --ls-max:360px; --ls-w:260px;
      --us-min:160px; --us-max:420px; --us-w:320px;
      --bar-w:6px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,.04);
      --shadow: 0 2px 8px rgba(0,0,0,.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,.12);
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#1e293b;
      --muted:#64748b;
      --brand:#3b82f6;
      --brand-dark:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --border:#e2e8f0;
      --hover:#f1f5f9;
      --accent:#8b5cf6;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;}
    body{color:var(--text);background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);font-size: 14px;line-height: 1.6;-webkit-font-smoothing: antialiased;}
    .app{height:100vh;display:grid;grid-template-columns:var(--ls-w) var(--bar-w) var(--us-w) var(--bar-w) 1fr;transition:grid-template-columns .3s cubic-bezier(0.4, 0, 0.2, 1);}
    .collapse-ls{grid-template-columns:0 var(--bar-w) var(--us-w) var(--bar-w) 1fr;}
    .collapse-us{grid-template-columns:var(--ls-w) var(--bar-w) 0 var(--bar-w) 1fr;}
    .collapse-both{grid-template-columns:0 0 0 0 1fr;}
    .sidebar{background:var(--card);box-shadow:var(--shadow);display:flex;flex-direction:column;backdrop-filter: blur(10px);} 
    .ls{padding:24px 20px;position:relative;overflow-y:visible;border-right: 1px solid var(--border);} 
    .us{padding:24px 20px;position:relative;overflow:auto;border-right: 1px solid var(--border);} 
    .main{background:transparent;padding:32px;overflow:auto;}
    .pane-title{font-size:11px;font-weight:600;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;margin:0 0 16px;display:flex;align-items:center;justify-content:space-between;}
    .btn{border:0;border-radius:8px;padding:12px 16px;font-weight:500;cursor:pointer;background:var(--hover);color:var(--text);width:100%;text-align:left;margin-bottom:8px;transition: all 0.2s ease;font-size: 13px;border: 1px solid transparent;}
    .btn:hover{background:#e2e8f0;transform: translateY(-1px);box-shadow: var(--shadow-sm);}    
    .btn.brand{background: var(--gradient);color:#fff;font-weight: 600;border: none;}    
    .muted{color:var(--muted);font-size: 13px;}

    .resizer{position:relative;background:transparent;width:var(--bar-w);cursor: col-resize;}
    .resizer::after{content:"";position:absolute;top:0;bottom:0;left:calc(50% - 1px);width:1px;background:var(--border);transition: background 0.2s ease;}
    .resizer:hover::after{background: var(--brand);}

    .topbar{position:sticky;top:0;z-index:5;display:flex;justify-content:space-between;align-items:flex-start;padding:20px 24px;background:rgba(255,255,255,0.9);border-bottom:1px solid var(--border);backdrop-filter: blur(10px);border-radius: 16px;margin-bottom: 24px;box-shadow: var(--shadow-sm);}    
    .user-info {display: flex;gap: 12px;align-items: center;}
    .topbar-actions {display: flex;gap: 8px;margin-top: 25px;} /* Â¢ûÂä†‰∏äËæπË∑ùÔºå‰ΩøÊåâÈíÆ‰∏ãÁßª */
    
    /* Ë∞ÉÊï¥‰∏ä‰º†Âå∫ÂüüÂ∞∫ÂØ∏ */
    .upload-card{background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);border:2px dashed var(--border);border-radius:12px;padding:16px;transition: all 0.3s ease;margin-bottom: 16px;}    
    input[type="file"]{width:100%;margin:8px 0;padding: 8px;border: 1px solid var(--border);border-radius: 6px;background: white;font-size: 12px;cursor: pointer;}    
    input[type="file"]::file-selector-button{background: var(--brand);color: white;border: none;padding: 6px 12px;border-radius: 4px;cursor: pointer;font-weight: 500;margin-right: 8px;transition: all 0.2s ease;font-size: 11px;}    
    
    .logout{display:block;margin-top:16px;color:var(--danger);text-decoration:none;font-size: 13px;font-weight: 500;padding: 8px 12px;border-radius: 6px;transition: all 0.2s ease;}    
    .document-item {position: relative;padding: 12px 32px 12px 16px;margin: 6px 0;background: white;border-radius: 8px;cursor: grab;border: 1px solid var(--border);transition: all 0.2s ease;font-size: 13px;font-weight: 500;}    
    .document-item:hover {background: var(--hover);transform: translateX(4px);box-shadow: var(--shadow-sm);border-color: var(--brand);}    
    .document-item.dragging {opacity: 0.5;transform: rotate(2deg) scale(0.95);}    
    .document-delete-btn {position: absolute;top: 50%;transform: translateY(-50%);right: 8px;width: 20px;height: 20px;border: none;background: #fee2e2;border-radius: 6px;cursor: pointer;color: var(--danger);font-size: 11px;display: flex;align-items: center;justify-content: center;padding: 0;transition: all 0.2s ease;}    
    .document-delete-btn:hover {background: var(--danger);color: white;}    
    .category {margin-bottom: 10px;position: relative;padding: 14px 16px;border-radius: 10px;cursor: pointer;transition: all 0.2s ease;border: 2px solid transparent;background: var(--hover);}    
    .category.drag-over {border-color: var(--brand);background: #dbeafe;transform: scale(1.02);box-shadow: var(--shadow);}    
    .category-title {font-weight: 600;margin-bottom: 8px;font-size: 14px;color: var(--text);}    
    .documents-list {min-height: 20px;padding: 8px;border-radius: 8px;background: var(--hover);}    
    .active-category {background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;border-color: var(--brand) !important;box-shadow: var(--shadow-sm);}    
    .delete-category {position: absolute;top: 10px;right: 10px;width: 24px;height: 24px;border: none;background: #fee2e2;border-radius: 6px;cursor: pointer;color: var(--danger);font-size: 13px;display: flex;align-items: center;justify-content: center;opacity: 0;transition: all 0.2s ease;}    
    .category:hover .delete-category {opacity: 1;}    
    .action-btn {background: var(--brand);color: white;border: none;border-radius: 8px;padding: 10px 20px;cursor: pointer;font-weight: 600;margin-left: 8px;transition: all 0.2s ease;font-size: 13px;box-shadow: var(--shadow-sm);}    
    .action-btn.secondary {background: var(--success);}    
    .action-btn.tertiary {background: var(--accent);} /* Êñ∞Â¢ûForeignerÊåâÈíÆÊ†∑Âºè */
    .template-selector-modal {position: fixed;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0,0,0,0.6);z-index: 1001;display: flex;justify-content: center;align-items: center;backdrop-filter: blur(4px);}    
    .template-selector-container {width: 75%;height: 75%;max-width: 900px;max-height: 650px;background: white;border-radius: 16px;display: flex;position: relative;box-shadow: var(--shadow-lg);overflow: hidden;}    
    .hidden {display: none;}    
    .categories-container {flex: 1;overflow-y: auto;margin-bottom: 16px;}    
    .main h1 {font-size: 32px;font-weight: 700;color: var(--text);margin-bottom: 8px;background: var(--gradient);-webkit-background-clip: text;-webkit-text-fill-color: transparent;background-clip: text;} 
    
    /* ÊäòÂè†ÂäüËÉΩÊ†∑Âºè */
    .app.collapse-ls #ls,
    .app.collapse-both #ls {
      box-shadow: none !important;
      padding: 0 !important;
      overflow: hidden !important;
      width: 0 !important;
      min-width: 0 !important;
    }
    .app.collapse-ls #bar-ls::after,
    .app.collapse-both #bar-ls::after { opacity: 0; }
    .app.collapse-us #us,
    .app.collapse-both #us {
      box-shadow: none !important;
      padding: 0 !important;
      overflow: hidden !important;
      width: 0 !important;
      min-width: 0 !important;
    }
    .app.collapse-us #bar-us::after,
    .app.collapse-both #bar-us::after { opacity: 0; }
    .app.collapse-ls #ls,
    .app.collapse-us #us { pointer-events: none; }
    #bar-ls, #bar-us { position: relative; }
    #bar-ls .collapse-btn, #bar-us .collapse-btn { pointer-events: auto; }
    
    .collapse-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      width: 18px;
      height: 24px;
      border: none;
      border-radius: 4px;
      background: #b3d9ff;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      color: var(--brand);
    }
    .collapse-btn:hover { background: #99ccff; }
    
    .ls {
      display: flex;
      flex-direction: column;
    }
    .account-section {
      margin-top: auto;
    }

    /* Template Selector Modal Styles */
    .template-selector-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1001;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .template-selector-container {
      width: 70%;
      height: 70%;
      max-width: 800px;
      max-height: 600px;
      background: white;
      border-radius: 8px;
      display: flex;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .template-selector-modal .sidebar {
      width: 200px;
      background-color: #f0f4f8;
      border-right: 1px solid #d6eaf8;
      padding: 15px;
      overflow-y: auto;
    }

    .template-selector-modal .sidebar-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .template-selector-modal .sidebar-section {
      margin-bottom: 20px;
    }

    .template-selector-modal .sidebar-section-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: bold;
    }

    .template-selector-modal .sidebar-item {
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .template-selector-modal .sidebar-item:hover {
      background-color: #e8f4f8;
    }

    .template-selector-modal .sidebar-item.active {
      background-color: #d6eaf8;
      font-weight: bold;
      color: var(--accent);
    }

    .template-selector-modal .arrow-icon {
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 4px solid var(--muted);
      margin-left: 8px;
    }

    .template-selector-modal .content-area {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      position: relative;
    }

    .template-selector-modal .content-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-content: flex-start;
    }

    .template-selector-modal .content-box {
      width: 240px;
      border: 1px solid #d6eaf8;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      background: #f8fbff;
      transition: all 0.2s ease;
    }

    .template-selector-modal .content-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .template-selector-modal .content-box-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--accent);
    }

    .template-selector-modal .content-box-description {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .template-selector-modal .content-box-footer {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #999;
    }

    .template-selector-modal .generate-button {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background-color: var(--brand);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .template-selector-modal .generate-button:hover {
      background-color: #1a4a7a;
    }

    .hidden {
      display: none;
    }

    /* Categories container for better organization */
    .categories-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    
    /* NEW STYLES - Enhanced UI to match the image */
    .main h1 {
      color: var(--accent);
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 24px;
    }
    
    .main-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    
    .document-preview {
      background: #f8fbff;
      border: 1px solid #d6eaf8;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .document-preview h2 {
      color: var(--accent);
      margin-top: 0;
      font-size: 20px;
      border-bottom: 1px solid #d6eaf8;
      padding-bottom: 8px;
    }
    
    .document-preview h3 {
      color: var(--brand);
      margin-top: 15px;
      font-size: 16px;
    }
    
    .document-preview ul {
      padding-left: 20px;
    }
    
    .document-preview li {
      margin-bottom: 5px;
    }
    
    .document-preview strong {
      color: var(--accent);
    }
    
    /* Enhanced sidebar styling */
    .ls .pane-title {
      font-size: 16px;
      color: var(--brand);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    .account-section .pane-title {
      font-size: 16px;
      color: var(--brand);
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }
    
    /* Enhanced button styling */
    .btn {
      border-radius: 6px;
      padding: 10px 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }
    
    .btn:before {
      content: "‚Ä¢";
      margin-right: 8px;
      color: var(--brand);
    }
    
    .btn.brand:before {
      color: white;
    }
    
    /* Enhanced category styling */
    .category {
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #d6eaf8;
      background: #f8fbff;
    }
    
    .category-title {
      font-size: 14px;
      color: var(--accent);
    }
    
    .active-category {
      background: #e8f5e8 !important;
      border-left: 4px solid var(--success);
    }
    
    /* Enhanced topbar styling */
    .topbar {
      background: white;
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .topbar .muted {
      font-weight: 500;
    }
    
    /* Enhanced upload card */
    .upload-card {
      background: #f8fbff;
      border: 2px dashed #b3d9ff;
      border-radius: 8px;
      padding: 16px;
    }
    
    /* Document list styling */
    .documents-list {
      background: white;
      border-radius: 6px;
      padding: 8px;
      border: 1px solid #e8f4f8;
    }
    
    /* Document item styling */
    .document-item {
      background: white;
      border: 1px solid #e8f4f8;
      border-radius: 6px;
      padding: 10px 30px 10px 12px;
      margin: 6px 0;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .document-item:hover {
      background: #f0f8ff;
      border-color: #b3d9ff;
    }
    
    /* Welcome message styling */
    .welcome-message {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 5px;
    }
    /* Âõ∫ÂÆöÂè≥‰∏äËßí logo Ê†∑Âºè */
    .top-right-logo {
     position: fixed;
     top: 0px;
     right: 20px;
     width: 80px;          /* logo Â§ßÂ∞èÂèØËá™Ë°åË∞ÉÊï¥ */
     height: auto;
     z-index: 1000;
}

    
    .profession-badge {
      display: inline-block;
      background: var(--light-bg);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 10px;
    }   
/* =======================
   TEMPLATE POPUP DESIGN
   ======================= */
.template-selector-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(3px);
}

.template-popup {
  background: #fff;
  width: 80%;
  height: 80%;
  display: flex;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.template-sidebar {
  width: 220px;
  background: #f8fafc;
  border-right: 1px solid #e2e8f0;
  padding: 20px;
  overflow-y: auto;
}

.template-sidebar h3 {
  font-size: 16px;
  color: #334155;
  margin-bottom: 16px;
}

.template-sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.template-sidebar li {
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  color: #475569;
  transition: all 0.2s;
}

.template-sidebar li:hover {
  background: #e0f2fe;
  color: #0284c7;
}

.template-sidebar li.active {
  background: linear-gradient(135deg, #3b82f6, #6366f1);
  color: white;
}

.template-content {
  flex: 1;
  padding: 24px;
  overflow-y: auto;
  position: relative;
}

.template-content h3 {
  margin-bottom: 16px;
  font-size: 18px;
  color: #334155;
}

.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 16px;
}

.template-card {
  border: 1px solid #e2e8f0;
  background: #f9fafb;
  border-radius: 10px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.template-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  border-color: #3b82f6;
}

.template-card h4 {
  font-size: 15px;
  color: #1e293b;
  margin-bottom: 8px;
}

.template-card p {
  font-size: 13px;
  color: #64748b;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.close-popup {
  position: absolute;
  top: 12px;
  right: 16px;
  background: transparent;
  border: none;
  color: #64748b;
  font-size: 26px;
  cursor: pointer;
  font-weight: bold;
}

.template-selector-modal {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.template-selector-modal:not(.hidden) {
  opacity: 1;
  pointer-events: all;
}

    /* Highlight selected template card */
.template-card.selected {
  border: 2px solid #3b82f6;
  background: #e0f2fe;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
}

/* "Generate Now" button */
.generate-now-btn {
  position: absolute;
  bottom: 20px;
  right: 24px;
  background: linear-gradient(135deg, #3b82f6, #6366f1);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(59,130,246,0.3);
  transition: all 0.2s ease;
}

.generate-now-btn:hover {
  background: linear-gradient(135deg, #2563eb, #4f46e5);
  transform: translateY(-2px);
}
.flash-messages {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}
.flash {
  background: #4caf50; /* green for success */
  color: white;
  padding: 10px 16px;
  border-radius: 6px;
  margin-bottom: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  animation: fadeOut 4s forwards;
}
.flash.error { background: #f44336; } /* red for error */
@keyframes fadeOut {
  0% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; display: none; }
}

    #uploadModal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }

  /* üîπ Popup box */
  #uploadModal .modal-content {
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    width: 380px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    animation: fadeIn 0.25s ease-in-out;
  }

  /* üîπ Simple fade animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* üîπ Buttons and input styles */
  #uploadModal input[type="text"] {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 16px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  #dropZone {
    border: 2px dashed #3b82f6;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    color: #3b82f6;
    margin-bottom: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #dropZone:hover, #dropZone.active {
    background-color: #f0f8ff;
  }

  #uploadModal button {
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
  }
  #cancelUpload {
    background-color: #eee;
    color: #333;
  }
  #addUpload {
    background-color: #3b82f6;
    color: #fff;
  }

    .document-item.selected {
  border: 2px solid #4CAF50;
  background-color: #eaffea;
  transition: 0.2s ease;
}
      #fullscreenLoader {
  position: fixed;
  inset: 0; /* top, right, bottom, left = 0 */
  background: rgba(0,0,0,0.45);
  display: none; /* hidden by default */
  justify-content: center;
  align-items: center;
  z-index: 99999; /* very high so it covers everything */
  backdrop-filter: blur(2px);
}

#fullscreenLoader .loader-box {
  background: white;
  padding: 22px 30px;
  border-radius: 10px;
  text-align: center;
  font-weight: 600;
  color: #3b82f6;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #cce5ff;
  border-top-color: #3b82f6;
  border-radius: 50%;
  margin: 0 auto 12px;
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

  </style>
</head>
<body>
  
  <img src="/static/images/logo.jpeg" alt="Logo" class="top-right-logo">
  <div id="fullscreenLoader">
      <div class="loader-box">
          <div class="spinner"></div>
          <p>Generating summary... Please wait</p>
      </div>
  </div>


  <div id="app" class="app">
    <aside id="ls" class="sidebar ls">
      <div class="pane-title">Categories <button id="addCategoryBtn" class="add-category-icon">+</button></div>
      <div class="categories-container">
        <div class="category active-category" data-category="all"><div class="category-title">All Documents</div></div>
      </div>
      <div class="account-section">
        <div class="pane-title">Account</div>
        <button class="btn" onclick="window.location.href='/feedback'">User Feedback</button>
        <button class="btn">{{ latest_membership }}</button>
        <button class="btn" onclick="window.location.href='/membership'">Purchase Plan</button>
        <a class="logout" href="/logout">Logout</a>
      </div>
    </aside>

    <div id="bar-ls" class="resizer"><button id="btnLS" class="collapse-btn">¬´</button></div>
    <aside id="us" class="sidebar us">
      <div class="pane-title">Upload Document</div>
      <!-- Ë∞ÉÊï¥ÂêéÁöÑ‰∏ä‰º†Âå∫Âüü -->
      <div class="upload-card text-center">
        <input type="hidden" id="folder_id" name="folder_id" value="">
        <button id="uploadBtn" class="btn brand" style="width:100%">Upload Document</button>
      </div>
      <div class="pane-title" style="margin-top:24px">Documents</div>
      
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
      <div id="current-category" class="muted" style="margin-bottom:12px">Showing: All Documents</div>
      <div id="documents-container" class="documents-list"></div>
    </aside>

    <div id="bar-us" class="resizer"><button id="btnUS" class="collapse-btn">¬´</button></div>

    <main class="main">
      <div class="topbar">
        <div class="user-info">
          <div class="muted">{{ name }}</div>
          <div class="muted">{{ profession }}</div>
        </div>
        <div class="topbar-actions">
          <button id="downloadBtn" class="action-btn secondary">Download</button>
          {% if latest_membership != "Free" %}
            <button id="generateBtn" class="action-btn">Generate</button>
          {% else %}
            <button id="generateBtn" class="action-btn" disabled title="Upgrade to use Generate">Generate</button>
          {% endif %}
          <button id="foreignerBtn" class="action-btn tertiary">share</button> <!-- Êñ∞Â¢ûForeignerÊåâÈíÆ -->
        </div>
      </div>
      <h1>Welcome back, {{ name }}</h1>
      <p class="welcome-subtitle muted">Manage your documents and generate summaries with ease</p>
        <div id="generatedText">

        </div>
    </main>
  </div>

  <!-- üìÑ NEW MODAL (Category-based template selector) -->
<div id="templateModal" class="template-selector-modal hidden">
  <div class="template-popup">
    <div class="template-sidebar">
      <h3>Categories</h3>
      <ul id="categoryList"></ul>
    </div>
    <div class="template-content">
      <h3 id="categoryTitle">Select a category</h3>
      <div id="templateCards" class="template-grid"></div>
    </div>
    <button class="close-popup" onclick="closeTemplateModal()">√ó</button>
    <button id="generateNowBtn" class="generate-now-btn">Generate Now</button>
  </div>
  
</div>
  

  <div id="uploadModal">
  <div class="modal-content">
    <h2 style="margin-top:0;margin-bottom:8px;">Attach Document</h2>
    <p style="font-size:14px;color:#666;margin-bottom:16px;">
      Your documents are fully secured and protected with us.
    </p>

    <form id="modalUploadForm" enctype="multipart/form-data" method="post" action="/upload-document">
      <input type="hidden" id="folder_id_modal" name="folder_id" value="">

      <label>Document Title</label>
      <input type="text" name="title" id="docTitle" placeholder="Enter title" required>

      <div id="dropZone">
        Choose file or drag and drop here<br>
        <span style="font-size:12px;color:#888;">Supported formats: PDF & DOCX</span>
        <input type="file" id="fileInput" name="file" accept=".pdf,.docx" class="hidden" required>
        <p id="fileNameDisplay" style="margin-top:10px; font-size:13px; color:#444;"></p>
      </div>

      <div style="text-align:right;">
        <button type="button" id="cancelUpload">Cancel</button>
        <button type="submit" id="addUpload">Add Document</button>
      </div>
    </form>
  </div>
</div>


<script>
  const $ = selector => document.querySelector(selector);
  const $$ = selector => document.querySelectorAll(selector);
  const app = $('#app');

  // ÊäòÂè†ÂäüËÉΩ
  function initResizeButtons() {
    const bLS = document.getElementById('btnLS');
    const bUS = document.getElementById('btnUS');
    if (bLS) bLS.textContent = '¬´';
    if (bUS) bUS.textContent = '¬´';
  }

  function state() {
    return { 
      hasLS: !app.classList.contains('collapse-ls'), 
      hasUS: !app.classList.contains('collapse-us') 
    }
  }

  function applyCollapse(ls, us) {
    app.classList.toggle('collapse-ls', !ls);
    app.classList.toggle('collapse-us', !us);
    app.classList.toggle('collapse-both', !ls && !us);
    
    const btnLS = document.getElementById('btnLS');
    const btnUS = document.getElementById('btnUS');
    if (btnLS) { btnLS.textContent = ls ? '¬´' : '¬ª'; }
    if (btnUS) { btnUS.textContent = us ? '¬´' : '¬ª'; }
  }

  document.getElementById('btnLS').onclick = () => { 
    const s = state(); 
    applyCollapse(!s.hasLS, s.hasUS); 
  };

  document.getElementById('btnUS').onclick = () => { 
    const s = state(); 
    applyCollapse(s.hasLS, !s.hasUS); 
  };

  function createDocumentItem(doc) {
    const div = document.createElement('div');
    div.className = 'document-item';
    div.textContent = doc.title || doc.filename || doc.name || 'untitled';
    div.dataset.docId = doc.id;
    div.dataset.fileName = doc.filename || doc.name || 'untitled';
    div.draggable = true;

    div.onclick = (e) => {
  e.stopPropagation();

  // Remove highlight from others
  document.querySelectorAll('.document-item.selected').forEach(item => {
    item.classList.remove('selected');
  });

  // Highlight this one
  div.classList.add('selected');
  window.selectedDocId = doc.id; // store selected document ID globally
  window.selectedDocName = doc.filename
  console.log('Selected document:', window.selectedDocId);
  loadSummaryForSelectedDoc(doc.id);

};


    const delBtn = document.createElement('button');
    delBtn.className = 'document-delete-btn';
    delBtn.textContent = 'üóë';
    delBtn.onclick = async (e) => {
      e.stopPropagation();
      if (confirm(`Delete "${div.dataset.fileName}"?`)) {
        await fetch(`/delete-document/${doc.id}`, { method: 'GET' });
        await loadDocuments();
      }
    };

    div.addEventListener('dragstart', function(e) {
      this.classList.add('dragging');
      e.dataTransfer.setData('text/plain', JSON.stringify({ docId: this.dataset.docId, fileName: this.dataset.fileName }));
      e.dataTransfer.effectAllowed = 'move';
    });

    div.addEventListener('dragend', function() { 
      this.classList.remove('dragging'); 
    });

    div.appendChild(delBtn);
    return div;
  }

  async function loadDocuments() {
    try {
      const res = await fetch('/get-documents');
      if (!res.ok) throw new Error('Failed to fetch documents');
      const docs = await res.json();
      const container = $('#documents-container');
      container.innerHTML = '';
      if (!Array.isArray(docs) || docs.length === 0) {
        container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);font-size:13px;">No documents found</div>';
        return;
      }
      docs.forEach(doc => container.appendChild(createDocumentItem(doc)));
    } catch (err) {
      console.error('Error loading documents:', err);
      const container = $('#documents-container');
      container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);font-size:13px;">Unable to load documents</div>';
    }
  }

  // Category management - ‰øùÊåÅÊâÄÊúâÊï∞ÊçÆÂ∫ìËøûÊé•‰∏çÂèò
  let categories = [];
  let documentCategories = {};
  let currentCategory = 'all';

  async function loadCategories() {
    try {
      const res = await fetch('/get_categories');
      if (!res.ok) throw new Error('Failed to load categories');
      categories = await res.json();
    } catch (err) {
      console.error('Error loading categories:', err);
      categories = [];
    }
    renderCategories();
  }

  function saveCategories() {
    localStorage.setItem('userCategories', JSON.stringify(categories));
    localStorage.setItem('documentCategories', JSON.stringify(documentCategories));
  }

  async function addCategory(name) {
    if (!name || !name.trim()) { alert('Category name cannot be empty.'); return; }
    try {
      const res = await fetch('/add_category', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ name: name.trim() }) 
      });
      const result = await res.json();
      if (result.success) { 
        categories.unshift({ id: result.id, name: result.name }); 
        renderCategories(); 
      } else {
        alert('Failed to add category: ' + (result.error || 'Unknown error'));
      }
    } catch (err) { 
      console.error('Error adding category:', err); 
      alert('Error adding category. See console.'); 
    }
  }

  async function deleteCategory(categoryId) {
    if (!confirm('Are you sure you want to delete this category? Documents will be moved back to All Documents.')) return;
    try {
      const res = await fetch(`/delete_category/${categoryId}`, { method: 'DELETE' });
      const result = await res.json();
      if (result.success) {
        categories = categories.filter(cat => String(cat.id) !== String(categoryId));
        if (currentCategory === String(categoryId)) setCurrentCategory('all');
        renderCategories();
        loadDocuments();
      } else {
        alert('Failed to delete category: ' + (result.error || 'Unknown error'));
      }
    } catch (err) { 
      console.error('Error deleting category:', err); 
      alert('Error deleting category. See console.'); 
    }
  }

  function setupDropZone(categoryElement) {
    categoryElement.addEventListener('dragover', function(e) { 
      e.preventDefault(); 
      e.dataTransfer.dropEffect = 'move'; 
      this.classList.add('drag-over'); 
    });
    
    categoryElement.addEventListener('dragleave', function(e) { 
      if (!this.contains(e.relatedTarget)) this.classList.remove('drag-over'); 
    });
    
    categoryElement.addEventListener('drop', async function(e) {
      e.preventDefault(); 
      this.classList.remove('drag-over');
      try {
        const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
        const targetCategory = this.dataset.category;
        const response = await fetch('/update-document-category', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ 
            documentId: dragData.docId, 
            category: targetCategory === 'all' ? null : targetCategory 
          }) 
        });
        if (response.ok) {
          if (targetCategory === 'all') {
            delete documentCategories[dragData.docId];
          } else {
            documentCategories[dragData.docId] = targetCategory;
          }
          saveCategories();
          loadDocuments();
          console.log(`Moved "${dragData.fileName}" to ${targetCategory === 'all' ? 'All Documents' : this.querySelector('.category-title').textContent}`);
        } else {
          alert('Failed to update document category');
        }
      } catch (err) { 
        console.error('Error handling drop:', err); 
      }
    });
  }

  function renderCategories() {
  const container = document.querySelector('.categories-container');

  // üîπ Keep All Documents and remove others
  const existing = container.querySelectorAll('.category:not([data-category="all"])');
  existing.forEach(el => el.remove());

  // üîπ Rebuild subfolders
  categories.forEach(category => {
    const categoryEl = document.createElement('div');
    categoryEl.className = 'category';
    categoryEl.dataset.category = String(category.id);

    const titleEl = document.createElement('div');
    titleEl.className = 'category-title';
    titleEl.textContent = category.name;

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-category';
    deleteBtn.textContent = 'üóë';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      deleteCategory(category.id);
    };

    categoryEl.appendChild(titleEl);
    categoryEl.appendChild(deleteBtn);
    categoryEl.onclick = () => setCurrentCategory(String(category.id));
    setupDropZone(categoryEl);
    container.appendChild(categoryEl);
  });

  // ‚úÖ Always reattach click event to "All Documents"
  const allCategory = container.querySelector('.category[data-category="all"]');
  if (allCategory) {
    allCategory.onclick = () => setCurrentCategory('all');
  }

  // ‚úÖ Maintain active highlight
  const activeEl = container.querySelector(`.category[data-category="${currentCategory}"]`);
  container.querySelectorAll('.category').forEach(c => c.classList.remove('active-category'));
  if (activeEl) activeEl.classList.add('active-category');
}

  

  function setCurrentCategory(categoryId) {
  currentCategory = categoryId;

  // Highlight active folder
  document.querySelectorAll('.category').forEach(c => c.classList.remove('active-category'));
  const el = document.querySelector(`.category[data-category="${categoryId}"]`);
  if (el) el.classList.add('active-category');

  // Update display text
  const categoryName = categoryId === 'all'
    ? 'All Documents'
    : (categories.find(cat => String(cat.id) === String(categoryId))?.name || categoryId);
  $('#current-category').textContent = `Showing: ${categoryName}`;

  // ‚úÖ Update hidden folder_id input before upload
  const folderInput = document.getElementById('folder_id');
  if (folderInput) {
    folderInput.value = (categoryId === 'all') ? '' : categoryId;
  }

  // Refresh file list for selected folder
  filterDocuments();
}



 async function filterDocuments() {
  try {
    const res = await fetch(`/get-documents?category=${currentCategory}`);
    if (!res.ok) throw new Error('Failed to fetch documents');

    const docs = await res.json();
    const container = document.getElementById('documents-container');
    container.innerHTML = '';

    if (!Array.isArray(docs) || docs.length === 0) {
      container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);font-size:13px;">No documents in this category</div>';
      return;
    }

    docs.forEach(doc => container.appendChild(createDocumentItem(doc)));
  } catch (err) {
    console.error('Error filtering documents:', err);
  }
}



 // ‚úÖ Template Modal - Final Fixed Version
const modal = document.getElementById('templateModal');
  const categoryList = document.getElementById('categoryList');
  const templateCards = document.getElementById('templateCards');
  const categoryTitle = document.getElementById('categoryTitle');
  const generateNowBtn = document.getElementById('generateNowBtn');
  const generateBtn = document.getElementById('generateBtn'); // <-- important

  let allTemplates = [];
  let selectedCategory = null;
  let selectedTemplateId = null;

  // Open modal when "Generate" is clicked
  if (generateBtn) {
  generateBtn.addEventListener('click', async () => {
    if (!window.selectedDocId) {
      alert('‚ö†Ô∏è Please select a document first before generating.');
      return;
    }

    // Open modal for template selection
    modal.classList.remove('hidden');
    await loadTemplates();
  });
}

  // Load templates
  async function loadTemplates() {
    try {
      const res = await fetch('/get_templates');
      allTemplates = await res.json();

      const categories = [...new Set(allTemplates.map(t => t.category || 'Uncategorized'))];
      categoryList.innerHTML = '';
      categories.forEach(cat => {
        const li = document.createElement('li');
        li.textContent = cat;
        li.onclick = () => showTemplatesByCategory(cat, li);
        categoryList.appendChild(li);
      });
    } catch (err) {
      console.error('Failed to load templates:', err);
    }
  }

  function showTemplatesByCategory(category, el) {
    selectedCategory = category;
    document.querySelectorAll('#categoryList li').forEach(li => li.classList.remove('active'));
    el.classList.add('active');
    categoryTitle.textContent = category;

    const filtered = allTemplates.filter(t => (t.category || 'Uncategorized') === category);
    templateCards.innerHTML = filtered.map(t => `
      <div class="template-card" data-id="${t.id}">
        <h4>${t.name}</h4>
        <p>${t.prompt}</p>
      </div>
    `).join('');

    document.querySelectorAll('.template-card').forEach(card => {
      card.addEventListener('click', () => selectTemplate(card));
    });
  }

  function selectTemplate(card) {
    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedTemplateId = card.getAttribute('data-id');
  }

  function closeTemplateModal() {
    modal.classList.add('hidden');
    selectedTemplateId = null;
    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
  }

generateNowBtn.addEventListener('click', async () => {
  if (!selectedTemplateId) {
    alert("‚ö†Ô∏è Please select a template first.");
    return;
  }

  const loader = document.getElementById("fullscreenLoader");
  const outputDiv = document.getElementById("generatedText");

  loader.style.display = "flex";
  outputDiv.textContent = "";

  const template = allTemplates.find(t => t.id == selectedTemplateId);

  try {
    const summaryRes = await fetch("/generateSummary", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        document_name: window.selectedDocName,
        document_id: window.selectedDocId,
        template_prompt: template.prompt,
        summaryTemplate:selectedTemplateId
      })
    });

    const data = await summaryRes.json();

    if (data.summary) {
      outputDiv.innerHTML = data.summary.replace(/\n/g, "<br>");
    } else {
      outputDiv.textContent = "‚ùå Error: " + (data.error || "Unknown error");
    }

  } catch (err) {
    outputDiv.textContent = "‚ö†Ô∏è Server error. Check console.";
    console.error(err);

  } finally {
    loader.style.display = "none"; // ‚úÖ HIDE POPUP OVERLAY
  }

  closeTemplateModal();
});


  // Close modal when clicking outside
  window.addEventListener('click', (e) => {
    if (e.target === modal) closeTemplateModal();
  });

  document.getElementById('addCategoryBtn').addEventListener('click', async () => {
  const name = prompt('Enter a name for the new category (subfolder):');
  if (name && name.trim()) {
    await addCategory(name.trim());
  }
});
  
document.addEventListener('DOMContentLoaded', () => {
  try {
    // init UI controls (resizer buttons)
    initResizeButtons();

    // load categories and documents into UI
    loadCategories();
    loadDocuments();

    // setup collapse button labels (safe guard)
    const s = state();
    const btnLS = document.getElementById('btnLS');
    const btnUS = document.getElementById('btnUS');
    if (btnLS) btnLS.textContent = s.hasLS ? '¬´' : '¬ª';
    if (btnUS) btnUS.textContent = s.hasUS ? '¬´' : '¬ª';

    // wire buttons if not already wired earlier
    if (btnLS) btnLS.onclick = () => { const st = state(); applyCollapse(!st.hasLS, st.hasUS); };
    if (btnUS) btnUS.onclick = () => { const st = state(); applyCollapse(st.hasLS, !st.hasUS); };
  } catch (err) {
    console.error('Init error:', err);
  }
});



  const uploadBtn = document.getElementById('uploadBtn');
const uploadModal = document.getElementById('uploadModal');
const cancelUpload = document.getElementById('cancelUpload');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const fileNameDisplay = document.getElementById('fileNameDisplay');
  

// üü¢ Open popup
uploadBtn.addEventListener('click', () => {
  uploadModal.style.display = 'flex';  // show overlay
});

// üî¥ Close popup
cancelUpload.addEventListener('click', () => {
  uploadModal.style.display = 'none';
  document.getElementById('modalUploadForm').reset();
});

// üß≤ Drag & drop zone
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('active');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  fileInput.files = e.dataTransfer.files;
  dropZone.classList.remove('active');
  // ‚úÖ Show dropped file name
  if (fileInput.files.length > 0) {
    fileNameDisplay.textContent = `Selected: ${fileInput.files[0].name}`;
  }
});

fileInput.addEventListener('change', () => {
  if (fileInput.files.length > 0) {
    fileNameDisplay.textContent = `Selected: ${fileInput.files[0].name}`;
  } else {
    fileNameDisplay.textContent = '';
  }
});
document.getElementById("downloadBtn").addEventListener("click", () => {
    const filename = "summary_"+window.selectedDocId+".pdf";
    const summaryText = document.getElementById("generatedText").innerText.trim();

    if (filename.includes("undefined")) {
        alert("‚ö†Ô∏è Please select a document first.");
        return;
    }
    if (!summaryText) {
        alert("‚ö†Ô∏è No summary available. Please generate summary first.");
        return;
    }
    window.location.href = `/download/${filename}`;
});

async function loadSummaryForSelectedDoc(docId) {
  const outputDiv = document.getElementById("generatedText");
  outputDiv.textContent = "‚è≥ Checking summary...";

  try {
    const res = await fetch(`/getSummary/${docId}`);
    const data = await res.json();

    if (data.summary) {
      outputDiv.innerHTML = data.summary.replace(/\n/g, "<br>");
    } else {
      outputDiv.textContent = "üìÑ No summary generated yet for this document.";
    }

  } catch (err) {
    outputDiv.textContent = "‚ö†Ô∏è Error fetching summary.";
    console.error(err);
  }
}


</script>
</body>
</html>

























