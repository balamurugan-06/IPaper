<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard — Document Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ls-min:140px; --ls-max:360px; --ls-w:220px;
      --us-min:160px; --us-max:420px; --us-w:260px;
      --bar-w:6px;
      --shadow: 0 1px 3px rgba(0,0,0,.08),0 6px 20px rgba(0,0,0,.06);
      --bg:#f5f5f7; --card:#fff; --text:#222; --muted:#666; --brand:#2962ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg);}
    .app{height:100vh;display:grid;
      grid-template-columns:var(--ls-w) var(--bar-w) var(--us-w) var(--bar-w) 1fr;
      transition:grid-template-columns .2s ease;}
    .collapse-ls{grid-template-columns:0 var(--bar-w) var(--us-w) var(--bar-w) 1fr;}
    .collapse-us{grid-template-columns:var(--ls-w) var(--bar-w) 0 var(--bar-w) 1fr;}
    .collapse-both{grid-template-columns:0 0 0 0 1fr;}
    .sidebar{background:var(--card);box-shadow:var(--shadow);display:flex;flex-direction:column;}
    .ls{padding:14px;position:relative;overflow-y:visible;}
    .us{padding:16px;position:relative;overflow:auto;}
    .main{background:transparent;padding:24px;overflow:auto;}
    .pane-title{font-size:12px;letter-spacing:.06em;color:var(--muted);text-transform:uppercase;margin:2px 0 10px;display:flex;align-items:center;justify-content:space-between;}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;
         background:#eceff1;color:#111;width:100%;text-align:left;margin-bottom:8px;}
    .btn.brand{background:var(--brand);color:#fff;}
    .btn.inline{width:auto;margin:0 8px 0 0;padding:8px 10px;}
    .muted{color:var(--muted);}
    .resizer{position:relative;background:transparent;width:var(--bar-w);}
    .resizer::after{content:"";position:absolute;top:0;bottom:0;left:calc(50% - 1px);width:2px;background:#e0e0e0;}
    .topbar{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;padding:10px;background:var(--card);border-bottom:1px solid #eee;}
    .upload-card{background:#fafafa;border:1px dashed #ddd;border-radius:12px;padding:14px;}
    input[type="file"]{width:100%;margin:10px 0;}
    .logout{display:block;margin-top:12px;color:var(--muted);text-decoration:none;}
    .collapse-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;width:18px;height:24px;border:none;border-radius:4px;background:#ddd;cursor:pointer;font-size:12px;line-height:1;}
    .collapse-btn:hover{background:#bbb;}
    .document-item{position:relative;padding:8px 24px 8px 8px;margin:4px 0;background:#f0f0f0;border-radius:6px;cursor:grab;border:1px solid #ddd;}
    .document-item:hover{background:#e0e0e0;}
    .document-item.dragging{opacity:.5;}
    .document-delete-btn{position:absolute;top:2px;right:2px;width:16px;height:16px;border:none;background:#ffebee;border-radius:50%;cursor:pointer;color:#c62828;font-size:10px;display:flex;align-items:center;justify-content:center;padding:0;}
    .document-delete-btn:hover{background:#ffcdd2;}
    .category{margin-bottom:12px;position:relative;padding-right:30px;}
    .category-title{font-weight:bold;margin-bottom:6px;}
    .documents-list{min-height:20px;padding:4px;border-radius:6px;background:#f8f8f8;}
    .active-category{background:#e8f5e9;}
    .delete-category{position:absolute;top:0;right:0;width:20px;height:20px;border:none;background:#ffebee;border-radius:4px;cursor:pointer;color:#c62828;font-size:12px;display:flex;align-items:center;justify-content:center;}
    .delete-category:hover{background:#ffcdd2;}
    .action-btn{background:var(--brand);color:white;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-weight:600;margin-left:8px;}
    .action-btn.secondary{background:#4caf50;}
    .topbar-actions{margin-left:auto;display:flex;gap:8px;}
    .add-category-icon{background:var(--brand);color:white;border:none;border-radius:4px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;}
    .add-category-icon:hover{opacity:.9;}
    .ls{display:flex;flex-direction:column;}
    .account-section{margin-top:auto;}
  </style>
</head>
<body>
<div id="app" class="app">
  <aside id="ls" class="sidebar ls">
    <div class="pane-title">Categories <button id="addCategoryBtn" class="add-category-icon">+</button></div>
    <div class="category active-category" data-category="all"><div class="category-title">All Documents</div></div>
    <div class="account-section">
      <div class="pane-title">Account</div>
      <button class="btn">User Feedback</button>
      <button class="btn">{{ latest_membership }}</button>
      <button class="btn" onclick="window.location.href='/membership'">Purchase Plan</button>
      <a class="logout" href="/logout">Logout</a>
    </div>
  </aside>
  <div id="bar-ls" class="resizer"><button id="btnLS" class="collapse-btn">«</button></div>
  <aside id="us" class="sidebar us">
    <div class="pane-title">Upload Document</div>
    <div class="upload-card">
      <form id="uploadForm" action="#" method="post" enctype="multipart/form-data">
        <input type="file" name="file" required multiple />
        <button type="submit" class="btn brand" style="width:100%">Upload</button>
      </form>
    </div>
    <div class="pane-title" style="margin-top:16px">Documents</div>
    <div id="current-category" class="muted" style="margin-bottom:6px">Showing: All Documents</div>
    <div id="documents-container" class="documents-list"></div>
  </aside>
  <div id="bar-us" class="resizer"><button id="btnUS" class="collapse-btn">«</button></div>
  <main class="main">
    <div class="topbar">
      <div class="muted">Welcome, {{ name }}</div>
      <div class="muted">{{ profession }}</div>
      <div class="topbar-actions">
        <button id="downloadBtn" class="action-btn secondary">Download</button>
        <button id="generateBtn" class="action-btn">Generate</button>
      </div>
    </div>
    <h1>Welcome, {{ name }}</h1>
    <p class="muted">上传文件后，可以从右侧栏拖拽到左侧分类中。</p>
  </main>
</div>

<script>
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const app=$('#app');
$('#btnLS').onclick=()=>app.classList.toggle('collapse-ls');
$('#btnUS').onclick=()=>app.classList.toggle('collapse-us');

const documents={all:new Set()};
let categories=[];
let currentCategory='all';

function createDocumentItem(name){
  const div=document.createElement('div');
  div.className='document-item';
  div.textContent=name;
  div.draggable=true;
  div.dataset.fileName=name;
  const del=document.createElement('button');
  del.className='document-delete-btn';
  del.textContent='×';
  del.onclick=e=>{e.stopPropagation();deleteDocument(name)};
  div.appendChild(del);
  div.addEventListener('dragstart',e=>{div.classList.add('dragging');e.dataTransfer.setData('text/plain',name)});
  div.addEventListener('dragend',()=>div.classList.remove('dragging'));
  return div;
}

function deleteDocument(n){
  for(const c in documents) documents[c].delete(n);
  displayDocuments();
}

function displayDocuments(){
  const cont=$('#documents-container');
  cont.innerHTML='';
  $('#current-category').textContent=`Showing: ${getCategoryName(currentCategory)}`;
  const list=currentCategory==='all'?Array.from(documents.all):Array.from(documents[currentCategory]||[]);
  list.forEach(f=>cont.appendChild(createDocumentItem(f)))
}

function getCategoryName(id){
  if(id==='all') return 'All Documents';
  const el=$(`.category[data-category="${id}"]`);
  return el?el.querySelector('.category-title').textContent:id;
}

function addCategory(name){
  const id=name.toLowerCase().replace(/\s+/g,'-');
  if(categories.includes(id)) return alert('Category exists');
  categories.push(id); documents[id]=new Set();
  renderCategories();
}

function renderCategories(){
  $$('.category:not([data-category="all"])').forEach(el=>el.remove());
  categories.forEach(c=>{
    const el=document.createElement('div');
    el.className='category';
    el.dataset.category=c;
    const t=document.createElement('div');
    t.className='category-title';
    t.textContent=c;
    const del=document.createElement('button');
    del.className='delete-category';
    del.textContent='×';
    del.onclick=e=>{e.stopPropagation();deleteCategory(c)};
    el.appendChild(t); el.appendChild(del);
    $('.category[data-category="all"]').after(el);
    el.onclick=()=>setCurrentCategory(c);
    setupDropZone(el);
  });
}

function setCurrentCategory(c){
  currentCategory=c;
  $$('.category').forEach(x=>x.classList.remove('active-category'));
  $(`.category[data-category="${c}"]`).classList.add('active-category');
  displayDocuments()
}

function setupDropZone(el){
  el.addEventListener('dragover',e=>e.preventDefault());
  el.addEventListener('drop',e=>{
    e.preventDefault();
    const f=e.dataTransfer.getData('text/plain');
    const cat=el.dataset.category;
    if(cat==='all') return;
    documents[cat].add(f);
    documents.all.delete(f);
    if(currentCategory===cat||currentCategory==='all') displayDocuments()
  })
}

function deleteCategory(id){
  if(id==='all') return;
  categories=categories.filter(c=>c!==id);
  delete documents[id];
  if(currentCategory===id) setCurrentCategory('all');
  renderCategories();
}

$('#addCategoryBtn').onclick=()=>{
  const n=prompt('Enter new category name:');
  if(n&&n.trim()) addCategory(n.trim())
}

$('#uploadForm').onsubmit=e=>{
  e.preventDefault();
  const files=e.target.querySelector('input[type=file]').files;
  for(let f of files) documents.all.add(f.name);
  if(currentCategory==='all') displayDocuments();
  e.target.reset()
}

$('.category[data-category="all"]').onclick=()=>setCurrentCategory('all');
setupDropZone($('.category[data-category="all"]'));
setCurrentCategory('all');
</script>
</body>
</html>
